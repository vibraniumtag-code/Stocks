<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Positions</title>

<style>
:root{
  --bg:#0b1020; --panel:#0f172a; --border:rgba(255,255,255,.08);
  --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.62);
  --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  --chip:rgba(255,255,255,.07); --shadow:0 14px 50px rgba(0,0,0,.45);
  --radius:14px; --font:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  --focus:rgba(124,58,237,.35);
}
*{box-sizing:border-box}
body{
  margin:0;padding:22px;
  background:
    radial-gradient(1200px 700px at 20% 0%, rgba(124,58,237,.25), transparent 55%),
    radial-gradient(900px 600px at 95% 12%, rgba(34,197,94,.18), transparent 50%),
    var(--bg);
  color:var(--text); font-family:var(--font);
}
.container{max-width:1200px;margin:auto}
h1{margin:0;font-size:24px}
.sub{margin-top:6px;color:var(--muted);font-size:13px}
.version{
  display:inline-block;margin-top:10px;
  padding:8px 12px;border-radius:999px;
  background:rgba(124,58,237,.18);
  border:1px solid rgba(124,58,237,.35);
  font-weight:800;font-size:13px;
}
.panel{
  margin-top:14px;background:rgba(255,255,255,.04);
  border:1px solid var(--border);border-radius:var(--radius);
  box-shadow:var(--shadow);overflow:hidden;
}
.toolbar{
  padding:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;
}
.chip{
  padding:7px 10px;border-radius:999px;
  background:var(--chip);border:1px solid var(--border);
  font-size:13px;color:var(--muted);display:flex;gap:8px;align-items:center;
}
.dot{width:8px;height:8px;border-radius:50%;background:var(--warn)}
.dot.ok{background:var(--ok)}
.dot.bad{background:var(--bad)}
.spacer{flex:1}
.input{
  display:flex;gap:8px;align-items:center;
  padding:8px 10px;border-radius:12px;
  border:1px solid var(--border);background:rgba(0,0,0,.2);
}
.input input{border:0;outline:none;background:transparent;color:var(--text)}
.btn{
  padding:9px 12px;border-radius:12px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.06);
  color:var(--text);font-weight:700;cursor:pointer;
}
.btn.primary{background:rgba(124,58,237,.25);border-color:rgba(124,58,237,.4)}
.btn.success{background:rgba(34,197,94,.22);border-color:rgba(34,197,94,.4)}
.btn.danger{background:rgba(239,68,68,.2);border-color:rgba(239,68,68,.4)}
.btn:disabled{opacity:.45;cursor:not-allowed}
.tableWrap{overflow:auto;border-top:1px solid var(--border)}
table{width:100%;border-collapse:collapse;min-width:900px}
thead th{
  position:sticky;top:0;
  background:rgba(10,14,28,.95);
  padding:10px;font-size:12px;color:var(--muted);
  border-bottom:1px solid var(--border);
}
tbody td{
  padding:9px 10px;font-size:13px;
  border-bottom:1px solid rgba(255,255,255,.06);
}
td[contenteditable]{outline:none}
td[contenteditable]:focus{box-shadow:0 0 0 3px var(--focus)}
.log,pre.err{
  margin-top:12px;padding:10px;border-radius:12px;
  background:rgba(0,0,0,.25);border:1px solid var(--border);
  font-size:12px;white-space:pre-wrap;
}
pre.err{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.3)}
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;
}
.modal{
  width:760px;max-width:95%;
  background:rgba(15,23,42,.95);
  border:1px solid var(--border);
  border-radius:16px;box-shadow:var(--shadow);
}
.mh,.mf{padding:14px;border-bottom:1px solid var(--border)}
.mf{border-top:1px solid var(--border);border-bottom:0;text-align:right}
.mb{padding:14px;display:grid;gap:12px}
.field{display:grid;gap:6px}
.field input{
  padding:10px;border-radius:12px;
  border:1px solid var(--border);
  background:rgba(0,0,0,.25);color:var(--text)
}
</style>
</head>

<body>
<div class="container">
  <h1>Positions</h1>
  <div class="sub">Edit ‚Ä¢ Download ‚Ä¢ Commit to GitHub (root CSV)</div>
  <div class="version">POSITION GUI v2026-01-25-TOKEN-SAVE</div>

  <div class="panel">
    <div class="toolbar">
      <span class="chip"><span id="dot" class="dot"></span><span id="status">Loading‚Ä¶</span></span>
      <span class="chip">CSV: <b>positions.csv</b></span>
      <div class="spacer"></div>
      <div class="input">üîé <input id="filter" placeholder="Filter"></div>
      <button class="btn" id="addRow">‚ûï</button>
      <button class="btn" id="download">‚¨áÔ∏è</button>
      <button class="btn primary" id="commit" disabled>Commit</button>
    </div>
    <div class="tableWrap"><table id="tbl"></table></div>
  </div>

  <div id="log" class="log" style="display:none"></div>
  <div id="fatal"></div>
</div>

<!-- Commit Modal -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="mh"><b>Commit to GitHub</b></div>
    <div class="mb">
      <div class="field"><label>Token (saved locally)</label>
        <input id="token" type="password" autocomplete="current-password">
        <button class="btn danger" id="clearToken">Clear saved token</button>
      </div>
    </div>
    <div class="mf">
      <button class="btn" id="close">Cancel</button>
      <button class="btn success" id="commitNow">Commit now</button>
    </div>
  </div>
</div>

<script>
(() => {
  const csvUrl = 'positions.csv?ts=' + Date.now();
  const TOKEN_KEY = 'stocks_pat_token_v1';

  const tbl = document.getElementById('tbl');
  const filter = document.getElementById('filter');
  const addRow = document.getElementById('addRow');
  const download = document.getElementById('download');
  const commitBtn = document.getElementById('commit');
  const overlay = document.getElementById('overlay');
  const closeBtn = document.getElementById('close');
  const commitNow = document.getElementById('commitNow');
  const tokenEl = document.getElementById('token');
  const clearToken = document.getElementById('clearToken');
  const logEl = document.getElementById('log');
  const fatalEl = document.getElementById('fatal');
  const statusEl = document.getElementById('status');
  const dotEl = document.getElementById('dot');

  let headers=[], data=[], dirty=false;

  // ---- token persistence ----
  try {
    const saved = localStorage.getItem(TOKEN_KEY);
    if (saved) tokenEl.value = saved;
  } catch {}
  tokenEl.addEventListener('input', () => {
    try {
      if (tokenEl.value.trim()) localStorage.setItem(TOKEN_KEY, tokenEl.value.trim());
    } catch {}
  });
  clearToken.onclick = () => {
    localStorage.removeItem(TOKEN_KEY);
    tokenEl.value = '';
    alert('Token cleared from this browser');
  };

  function fatal(msg){ fatalEl.innerHTML = `<pre class="err">${msg}</pre>`; }
  window.addEventListener('unhandledrejection', e => fatal(e.reason));
  window.addEventListener('error', e => fatal(e.message));

  function render(){
    let html='<thead><tr>';
    headers.forEach(h=>html+=`<th>${h}</th>`); html+='</tr></thead><tbody>';
    data.forEach((r,i)=>{
      html+='<tr>'+r.map((c,j)=>`<td contenteditable oninput="window._edit(${i},${j},this)">${c}</td>`).join('')+'</tr>';
    });
    tbl.innerHTML=html+'</tbody>';
  }
  window._edit=(i,j,el)=>{data[i][j]=el.textContent;dirty=true;commitBtn.disabled=false};

  fetch(csvUrl).then(r=>r.text()).then(t=>{
    const rows=t.trim().split('\n').map(l=>l.split(','));
    headers=rows.shift(); data=rows;
    statusEl.textContent='Loaded'; dotEl.className='dot ok';
    render();
  }).catch(e=>fatal(e));

  download.onclick=()=>{
    const csv=[headers,...data].map(r=>r.join(',')).join('\n');
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([csv]));
    a.download='positions.csv'; a.click();
  };

  commitBtn.onclick=()=>overlay.style.display='flex';
  closeBtn.onclick=()=>overlay.style.display='none';

  commitNow.onclick=async()=>{
    try{
      const token=tokenEl.value.trim();
      if(!token) throw 'Token required';
      const csv=[headers,...data].map(r=>r.join(',')).join('\n');
      const b64=btoa(unescape(encodeURIComponent(csv)));
      const r1=await fetch('https://api.github.com/repos/vibraniumtag-code/Stocks/contents/positions.csv',{
        headers:{Authorization:`Bearer ${token}`}
      });
      const j=await r1.json();
      await fetch('https://api.github.com/repos/vibraniumtag-code/Stocks/contents/positions.csv',{
        method:'PUT',
        headers:{
          Authorization:`Bearer ${token}`,
          'Content-Type':'application/json'
        },
        body:JSON.stringify({message:'Update positions.csv (web)',content:b64,sha:j.sha})
      });
      alert('Committed');
      dirty=false; commitBtn.disabled=true; overlay.style.display='none';
    }catch(e){fatal(e)}
  };
})();
</script>
</body>
</html>