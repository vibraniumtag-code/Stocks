<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Positions</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    .bar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom: 12px; }
    .pill { padding:6px 10px; border:1px solid #ddd; border-radius:999px; }
    .ok { color:#0a7; }
    .bad { color:#c22; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #eee; padding: 8px; font-size: 14px; }
    th { background:#fafafa; position: sticky; top: 0; text-align:left; }
    input { padding:8px; border:1px solid #ddd; border-radius:8px; min-width:240px; }
    pre { background:#111; color:#eee; padding:10px; border-radius:10px; }
  </style>
</head>

<body>
  <h1>Positions</h1>

  <div class="bar">
    <span class="pill" id="status">Loading…</span>
    <span class="pill" id="meta"></span>
    <input id="filter" placeholder="Filter rows…" />
  </div>

  <div id="error" style="display:none;">
    <p class="bad"><strong>Failed to load positions.csv</strong></p>
    <pre id="errorText"></pre>
  </div>

  <div style="overflow:auto;">
    <table id="tbl"></table>
  </div>

<script>
(() => {
  const statusEl = document.getElementById('status');
  const metaEl   = document.getElementById('meta');
  const errBox   = document.getElementById('error');
  const errText  = document.getElementById('errorText');
  const tbl      = document.getElementById('tbl');
  const filterEl = document.getElementById('filter');

  // Same-folder load (docs/positions.html → docs/positions.csv)
  const csvUrl = 'positions.csv?ts=' + Date.now();

  const setStatus = (ok, msg) => {
    statusEl.textContent = msg;
    statusEl.className = 'pill ' + (ok ? 'ok' : 'bad');
  };

  const parseCSV = (text) => {
    const rows = [];
    let row = [], cur = '', inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i], n = text[i + 1];
      if (c === '"' && inQuotes && n === '"') { cur += '"'; i++; continue; }
      if (c === '"') { inQuotes = !inQuotes; continue; }
      if (!inQuotes && (c === ',' || c === '\n' || c === '\r')) {
        row.push(cur); cur = '';
        if (c === '\n' && row.some(v => v.trim() !== '')) rows.push(row), row = [];
        continue;
      }
      cur += c;
    }
    if (cur || row.length) { row.push(cur); rows.push(row); }
    return rows;
  };

  const render = (headers, data) => {
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      trh.appendChild(th);
    });
    thead.appendChild(trh);

    const tbody = document.createElement('tbody');
    data.forEach(r => {
      const tr = document.createElement('tr');
      headers.forEach((_, i) => {
        const td = document.createElement('td');
        td.textContent = (r[i] ?? '').trim();
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    tbl.innerHTML = '';
    tbl.append(thead, tbody);
  };

  filterEl.addEventListener('input', () => {
    const q = filterEl.value.toLowerCase();
    tbl.querySelectorAll('tbody tr').forEach(tr => {
      tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
    });
  });

  fetch(csvUrl, { cache: 'no-store' })
    .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.text(); })
    .then(text => {
      const rows = parseCSV(text);
      const headers = rows[0];
      const data = rows.slice(1);
      render(headers, data);
      setStatus(true, 'Loaded');
      metaEl.textContent = `${data.length} rows`;
    })
    .catch(err => {
      setStatus(false, 'Load failed');
      errBox.style.display = 'block';
      errText.textContent = err.toString();
    });
})();
</script>
</body>
</html>
