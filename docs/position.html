<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Positions</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f172a;
      --panel2:#0b132b;
      --border:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.45);
      --accent:#7c3aed;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --chip:rgba(255,255,255,.07);
      --focus:rgba(124,58,237,.35);
      --shadow: 0 14px 50px rgba(0,0,0,.45);
      --radius:14px;
      --radius2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:22px;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(124,58,237,.25), transparent 55%),
                  radial-gradient(900px 600px at 95% 12%, rgba(34,197,94,.18), transparent 50%),
                  var(--bg);
      color:var(--text);
      font-family: var(--font);
    }
    .container{ max-width: 1200px; margin:0 auto; }
    .top{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
      margin-bottom: 14px;
    }
    .title{
      display:flex; flex-direction:column; gap:6px;
    }
    h1{ margin:0; font-size: 24px; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:13px; }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .toolbar{
      padding:12px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border:1px solid var(--border);
      background: var(--chip);
      border-radius:999px;
      font-size: 13px;
      color: var(--muted);
      user-select:none;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: var(--warn); box-shadow: 0 0 0 3px rgba(245,158,11,.15); }
    .dot.ok{ background: var(--accent2); box-shadow: 0 0 0 3px rgba(34,197,94,.15); }
    .dot.bad{ background: var(--danger); box-shadow: 0 0 0 3px rgba(239,68,68,.15); }
    .spacer{ flex:1; }
    .input{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      border-radius: 12px;
      min-width: 260px;
    }
    .input input{
      width:100%;
      border:0; outline:none;
      background: transparent;
      color: var(--text);
      font-size: 14px;
    }
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:9px 11px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
      font-size: 13px;
      display:inline-flex; align-items:center; gap:8px;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.14); }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .btn.primary{
      border-color: rgba(124,58,237,.35);
      background: rgba(124,58,237,.20);
    }
    .btn.primary:hover{ background: rgba(124,58,237,.26); }
    .btn.success{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.18);
    }
    .btn.danger{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.16);
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .tableWrap{
      overflow:auto;
      border-top:1px solid var(--border);
      border-radius: 0 0 var(--radius) var(--radius);
    }
    table{ width:100%; border-collapse: collapse; min-width: 980px; }
    thead th{
      position: sticky; top: 0; z-index: 2;
      background: rgba(10,14,28,.92);
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border);
      color: rgba(255,255,255,.78);
      text-align:left;
      font-size: 12px;
      letter-spacing: .35px;
      padding: 10px 10px;
      cursor:pointer;
      user-select:none;
    }
    thead th:first-child{ cursor: default; }
    tbody td{
      border-bottom:1px solid rgba(255,255,255,.06);
      padding: 9px 10px;
      font-size: 13px;
      color: rgba(255,255,255,.88);
      white-space: nowrap;
    }
    tbody tr:hover td{ background: rgba(255,255,255,.03); }
    td[contenteditable="true"]{ outline:none; border-radius: 8px; }
    td[contenteditable="true"]:focus{
      box-shadow: 0 0 0 3px var(--focus);
      background: rgba(124,58,237,.10);
    }
    td.edited{ background: rgba(245,158,11,.10); }
    .right{ text-align:right; }
    .muted{ color: var(--muted); }
    .note{
      margin-top: 10px;
      color: var(--muted2);
      font-size: 12.5px;
      line-height: 1.4;
    }

    /* modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width: min(720px, 100%);
      border-radius: 16px;
      border:1px solid var(--border);
      background: rgba(15,23,42,.92);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      padding: 14px 14px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border-bottom: 1px solid var(--border);
    }
    .modalHeader h2{ margin:0; font-size: 16px; }
    .modalBody{ padding: 14px; display:grid; gap:12px; }
    .row{
      display:grid; gap:8px;
      grid-template-columns: 1fr 1fr;
    }
    .field{ display:grid; gap:6px; }
    label{ font-size: 12px; color: var(--muted); }
    .field input, .field textarea{
      width:100%;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--text);
      border-radius: 12px;
      padding: 10px;
      outline:none;
      font-size: 13px;
    }
    .field textarea{ min-height: 70px; resize: vertical; }
    .modalFooter{
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }
    .help{
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.35;
    }
    pre.err{
      background: rgba(239,68,68,.10);
      border: 1px solid rgba(239,68,68,.22);
      color: rgba(255,255,255,.9);
      padding: 10px;
      border-radius: 12px;
      overflow:auto;
      margin:0;
      font-size: 12px;
    }
    .kbd{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      border-bottom-color: rgba(255,255,255,.12);
      padding: 2px 7px;
      border-radius: 8px;
      font-size: 12px;
      color: rgba(255,255,255,.78);
    }
  </style>
</head>

<body>
<div class="container">
  <div class="top">
    <div class="title">
      <h1>Positions</h1>
      <div class="sub">Edit in place ‚Ä¢ Sort columns ‚Ä¢ Add/Delete rows ‚Ä¢ Download or Commit to GitHub</div>
    </div>
  </div>

  <div class="panel">
    <div class="toolbar">
      <span class="chip"><span id="dot" class="dot"></span><span id="status">Loading‚Ä¶</span></span>
      <span class="chip"><span class="muted">Rows:</span> <strong id="rowsMeta">‚Äî</strong></span>
      <span class="chip"><span class="muted">Source:</span> <strong>docs/positions.csv</strong></span>

      <div class="spacer"></div>

      <div class="input" title="Filter rows">
        üîé <input id="filter" placeholder="Filter rows‚Ä¶" />
      </div>

      <button class="btn" id="addRowBtn">‚ûï Add row</button>
      <button class="btn danger" id="deleteRowsBtn" disabled>üóëÔ∏è Delete selected</button>
      <button class="btn" id="downloadBtn" disabled>‚¨áÔ∏è Download CSV</button>
      <button class="btn primary" id="commitBtn" disabled>‚úÖ Commit to GitHub</button>
      <button class="btn" id="resetBtn" disabled>‚Ü©Ô∏è Reset</button>
    </div>

    <div class="tableWrap">
      <table id="tbl"></table>
    </div>
  </div>

  <div class="note">
    Tip: Click a column header to sort. Use <span class="kbd">Download CSV</span> for a safe offline save.
    <br>
    ‚ÄúCommit to GitHub‚Äù uses the GitHub API and requires a fine-grained token with <span class="kbd">Contents: Read & Write</span> for this repo.
    Never hardcode tokens into the HTML.
  </div>
</div>

<!-- Commit Modal -->
<div class="modalOverlay" id="modalOverlay">
  <div class="modal">
    <div class="modalHeader">
      <div>
        <h2>Commit updated CSV to GitHub</h2>
        <div class="help">This will overwrite <b>docs/positions.csv</b> on your selected branch.</div>
      </div>
      <button class="btn" id="closeModalBtn">‚úñ</button>
    </div>

    <div class="modalBody">
      <div class="row">
        <div class="field">
          <label>Repo owner (e.g. your GitHub username)</label>
          <input id="owner" placeholder="owner" />
        </div>
        <div class="field">
          <label>Repo name</label>
          <input id="repo" placeholder="repo" />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Branch</label>
          <input id="branch" placeholder="main" />
        </div>
        <div class="field">
          <label>Path to write</label>
          <input id="path" value="docs/positions.csv" />
        </div>
      </div>

      <div class="field">
        <label>Commit message</label>
        <input id="message" value="Update positions.csv (web)" />
      </div>

      <div class="field">
        <label>GitHub token (fine-grained PAT) ‚Äî NOT saved unless you choose</label>
        <input id="token" type="password" placeholder="ghp_‚Ä¶ or github_pat_‚Ä¶" />
        <div class="help">
          Create a <b>fine-grained</b> token scoped to this repo with <b>Contents: Read & Write</b>.
          If your repo is public, don‚Äôt use this approach (anyone could copy your page and trick you). Best for private repos.
        </div>
      </div>

      <div class="field">
        <label><input type="checkbox" id="remember"> Remember token in this browser (localStorage) ‚Äî optional</label>
        <div class="help">Not recommended on shared computers.</div>
      </div>

      <div id="commitResult"></div>
    </div>

    <div class="modalFooter">
      <button class="btn" id="testBtn">üîç Test access</button>
      <button class="btn success" id="doCommitBtn">‚úÖ Commit now</button>
    </div>
  </div>
</div>

<script>
(() => {
  // ===== Elements =====
  const tbl = document.getElementById('tbl');
  const filterEl = document.getElementById('filter');
  const addRowBtn = document.getElementById('addRowBtn');
  const deleteRowsBtn = document.getElementById('deleteRowsBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const commitBtn = document.getElementById('commitBtn');
  const resetBtn = document.getElementById('resetBtn');

  const statusEl = document.getElementById('status');
  const dotEl = document.getElementById('dot');
  const rowsMetaEl = document.getElementById('rowsMeta');

  // modal
  const modalOverlay = document.getElementById('modalOverlay');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const ownerEl = document.getElementById('owner');
  const repoEl = document.getElementById('repo');
  const branchEl = document.getElementById('branch');
  const pathEl = document.getElementById('path');
  const msgEl = document.getElementById('message');
  const tokenEl = document.getElementById('token');
  const rememberEl = document.getElementById('remember');
  const testBtn = document.getElementById('testBtn');
  const doCommitBtn = document.getElementById('doCommitBtn');
  const commitResult = document.getElementById('commitResult');

  // ===== State =====
  const csvUrl = 'positions.csv?ts=' + Date.now(); // docs/positions.html ‚Üí docs/positions.csv
  let headers = [];
  let data = [];
  let originalData = [];
  let sortState = { col: -1, dir: 1 };
  let dirty = false;

  // ===== Helpers =====
  const setStatus = (kind, text) => {
    statusEl.textContent = text;
    dotEl.className = 'dot ' + (kind === 'ok' ? 'ok' : kind === 'bad' ? 'bad' : '');
  };
  const deepCopy = (x) => JSON.parse(JSON.stringify(x));
  const markDirty = () => {
    dirty = true;
    resetBtn.disabled = false;
    commitBtn.disabled = false;
  };

  // CSV parse with quotes
  const parseCSV = (text) => {
    const rows = [];
    let row = [], cur = '', inQuotes = false;
    for (let i=0; i<text.length; i++){
      const c = text[i], n = text[i+1];
      if (c === '"' && inQuotes && n === '"'){ cur += '"'; i++; continue; }
      if (c === '"'){ inQuotes = !inQuotes; continue; }
      if (!inQuotes && (c === ',' || c === '\n' || c === '\r')){
        row.push(cur); cur = '';
        if (c === '\n'){
          if (row.some(v => v.trim() !== '')) rows.push(row);
          row = [];
        }
        continue;
      }
      cur += c;
    }
    if (cur.length || row.length){ row.push(cur); rows.push(row); }
    return rows;
  };

  const csvEscape = (s) => {
    s = (s ?? '').toString();
    if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
    return s;
  };

  const toCSV = (headers, rows) => {
    const lines = [];
    lines.push(headers.map(csvEscape).join(','));
    for (const r of rows){
      const rr = headers.map((_, i) => csvEscape(r[i] ?? ''));
      lines.push(rr.join(','));
    }
    return lines.join('\n') + '\n';
  };

  const updateDeleteState = () => {
    const anyChecked = tbl.querySelectorAll('tbody input[type="checkbox"]:checked').length > 0;
    deleteRowsBtn.disabled = !anyChecked;
  };

  const sortBy = (colIdx, dir) => {
    const num = (v) => {
      const s = (v ?? '').toString().trim().replace(/,/g,'');
      if (s === '') return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    };
    data.sort((a,b) => {
      const av = a[colIdx] ?? '', bv = b[colIdx] ?? '';
      const an = num(av), bn = num(bv);
      if (an !== null && bn !== null) return (an - bn) * dir;
      return av.toString().localeCompare(bv.toString(), undefined, { numeric:true, sensitivity:'base' }) * dir;
    });
  };

  const render = () => {
    const q = filterEl.value.toLowerCase().trim();
    const visibleIdx = [];
    data.forEach((r, idx) => {
      const txt = r.join(' ').toLowerCase();
      if (!q || txt.includes(q)) visibleIdx.push(idx);
    });
    rowsMetaEl.textContent = `${visibleIdx.length} shown / ${data.length} total`;

    const thead = document.createElement('thead');
    const trh = document.createElement('tr');

    const thSel = document.createElement('th');
    thSel.textContent = '‚úì';
    thSel.style.cursor = 'default';
    trh.appendChild(thSel);

    headers.forEach((h, colIdx) => {
      const th = document.createElement('th');
      const arrow = (sortState.col === colIdx) ? (sortState.dir === 1 ? ' ‚ñ≤' : ' ‚ñº') : '';
      th.textContent = h + arrow;
      th.addEventListener('click', () => {
        if (sortState.col === colIdx) sortState.dir *= -1;
        else { sortState.col = colIdx; sortState.dir = 1; }
        sortBy(colIdx, sortState.dir);
        render();
      });
      trh.appendChild(th);
    });
    thead.appendChild(trh);

    const tbody = document.createElement('tbody');
    visibleIdx.forEach((rowIdx) => {
      const tr = document.createElement('tr');

      const tdSel = document.createElement('td');
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.rowIndex = rowIdx;
      cb.addEventListener('change', updateDeleteState);
      tdSel.appendChild(cb);
      tr.appendChild(tdSel);

      headers.forEach((_, colIdx) => {
        const td = document.createElement('td');
        td.contentEditable = "true";
        td.spellcheck = false;
        td.textContent = (data[rowIdx][colIdx] ?? '').toString();

        td.addEventListener('input', () => {
          data[rowIdx][colIdx] = td.textContent;
          td.classList.add('edited');
          markDirty();
        });

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    tbl.innerHTML = '';
    tbl.appendChild(thead);
    tbl.appendChild(tbody);
    updateDeleteState();
  };

  // ===== Actions =====
  filterEl.addEventListener('input', render);

  addRowBtn.addEventListener('click', () => {
    data.unshift(headers.map(() => ''));
    markDirty();
    render();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  deleteRowsBtn.addEventListener('click', () => {
    const checked = Array.from(tbl.querySelectorAll('tbody input[type="checkbox"]:checked'))
      .map(cb => Number(cb.dataset.rowIndex))
      .sort((a,b)=>b-a);
    if (!checked.length) return;
    for (const idx of checked) data.splice(idx, 1);
    markDirty();
    render();
  });

  downloadBtn.addEventListener('click', () => {
    const csv = toCSV(headers, data);
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'positions.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  resetBtn.addEventListener('click', () => {
    data = deepCopy(originalData);
    dirty = false;
    resetBtn.disabled = true;
    commitBtn.disabled = true;
    sortState = { col:-1, dir:1 };
    render();
  });

  // ===== Modal controls =====
  const openModal = () => {
    commitResult.innerHTML = '';
    modalOverlay.style.display = 'flex';

    // Try to auto-fill owner/repo from location if possible
    // URL looks like https://owner.github.io/repo/positions.html
    try{
      const host = location.hostname; // owner.github.io
      const parts = location.pathname.split('/').filter(Boolean); // [repo, positions.html]
      const ownerGuess = host.split('.')[0];
      if (!ownerEl.value) ownerEl.value = ownerGuess || '';
      if (!repoEl.value) repoEl.value = parts[0] || '';
      if (!branchEl.value) branchEl.value = 'main';
    }catch(e){}

    // Load remembered token if selected
    const saved = localStorage.getItem('pm_github_token');
    if (saved && !tokenEl.value) tokenEl.value = saved;
    rememberEl.checked = !!saved;
  };

  const closeModal = () => {
    modalOverlay.style.display = 'none';
  };

  commitBtn.addEventListener('click', openModal);
  closeModalBtn.addEventListener('click', closeModal);
  modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });

  const setResult = (html) => { commitResult.innerHTML = html; };

  const apiHeaders = (token) => ({
    'Accept': 'application/vnd.github+json',
    'Authorization': `Bearer ${token}`,
    'X-GitHub-Api-Version': '2022-11-28'
  });

  const getFileSHA = async ({owner, repo, path, branch, token}) => {
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path).replace(/%2F/g,'/')}` +
                `?ref=${encodeURIComponent(branch)}`;
    const res = await fetch(url, { headers: apiHeaders(token) });
    if (res.status === 404) return null; // file doesn't exist yet
    if (!res.ok) throw new Error(`Failed to read file: HTTP ${res.status}`);
    const json = await res.json();
    return json.sha || null;
  };

  const putFile = async ({owner, repo, path, branch, token, message, contentBase64, sha}) => {
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path).replace(/%2F/g,'/')}`;
    const body = {
      message,
      content: contentBase64,
      branch
    };
    if (sha) body.sha = sha;

    const res = await fetch(url, {
      method: 'PUT',
      headers: { ...apiHeaders(token), 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) {
      const msg = json && json.message ? json.message : `HTTP ${res.status}`;
      throw new Error(`Commit failed: ${msg}`);
    }
    return json;
  };

  const b64encodeUTF8 = (str) => {
    // base64 for UTF-8
    const bytes = new TextEncoder().encode(str);
    let bin = '';
    bytes.forEach(b => bin += String.fromCharCode(b));
    return btoa(bin);
  };

  testBtn.addEventListener('click', async () => {
    try{
      setResult('');
      const owner = ownerEl.value.trim();
      const repo = repoEl.value.trim();
      const branch = branchEl.value.trim() || 'main';
      const path = pathEl.value.trim() || 'docs/positions.csv';
      const token = tokenEl.value.trim();

      if (!owner || !repo || !token) throw new Error('Owner, repo, and token are required.');
      const sha = await getFileSHA({owner, repo, path, branch, token});
      setResult(`<div class="chip"><span class="dot ok"></span><span>Access OK. Current SHA: <b>${sha ? sha.slice(0,7) : '(new file)'}</b></span></div>`);
    }catch(e){
      setResult(`<pre class="err">${String(e && e.stack ? e.stack : e)}</pre>`);
    }
  });

  doCommitBtn.addEventListener('click', async () => {
    try{
      setResult('');
      const owner = ownerEl.value.trim();
      const repo = repoEl.value.trim();
      const branch = branchEl.value.trim() || 'main';
      const path = pathEl.value.trim() || 'docs/positions.csv';
      const message = msgEl.value.trim() || 'Update positions.csv (web)';
      const token = tokenEl.value.trim();

      if (!owner || !repo || !token) throw new Error('Owner, repo, and token are required.');

      // Remember token if user chose
      if (rememberEl.checked) localStorage.setItem('pm_github_token', token);
      else localStorage.removeItem('pm_github_token');

      const csv = toCSV(headers, data);
      const contentBase64 = b64encodeUTF8(csv);

      setResult(`<div class="chip"><span class="dot"></span><span>Committing‚Ä¶</span></div>`);

      const sha = await getFileSHA({owner, repo, path, branch, token});
      const result = await putFile({owner, repo, path, branch, token, message, contentBase64, sha});

      const commitUrl = (result && result.commit && result.commit.html_url) ? result.commit.html_url : '';
      const contentUrl = (result && result.content && result.content.html_url) ? result.content.html_url : '';

      // Mark clean
      originalData = deepCopy(data);
      dirty = false;
      resetBtn.disabled = true;
      commitBtn.disabled = true;

      setResult(`
        <div class="chip"><span class="dot ok"></span><span><b>Committed successfully.</b></span></div>
        <div class="help">
          ${commitUrl ? `Commit: <a href="${commitUrl}" target="_blank" rel="noreferrer" style="color:#c4b5fd;">open</a><br>` : ''}
          ${contentUrl ? `File: <a href="${contentUrl}" target="_blank" rel="noreferrer" style="color:#c4b5fd;">open</a>` : ''}
        </div>
      `);
    }catch(e){
      setResult(`<pre class="err">${String(e && e.stack ? e.stack : e)}</pre>`);
    }
  });

  // ===== Load =====
  (async () => {
    try{
      setStatus('warn', 'Loading‚Ä¶');
      const res = await fetch(csvUrl, { cache:'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status} while fetching positions.csv`);
      const text = await res.text();

      const rows = parseCSV(text);
      if (!rows.length) throw new Error('CSV loaded but empty.');

      headers = rows[0].map(x => x.trim());
      data = rows.slice(1).map(r => {
        const rr = r.slice(0, headers.length);
        while (rr.length < headers.length) rr.push('');
        return rr;
      });
      originalData = deepCopy(data);

      setStatus('ok', 'Loaded');
      downloadBtn.disabled = false;
      render();
    }catch(e){
      setStatus('bad', 'Load failed');
      rowsMetaEl.textContent = '‚Äî';
      tbl.innerHTML = `<tbody><tr><td style="padding:14px;color:rgba(255,255,255,.8)">
        Failed to load CSV. Check that <b>docs/positions.csv</b> exists and you‚Äôre using the GitHub Pages URL.
        <br><br><span class="muted">${String(e)}</span>
      </td></tr></tbody>`;
    }
  })();
})();
</script>
</body>
</html>
