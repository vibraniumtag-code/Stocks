name: Nightly Turtle Scanner (Email + Artifacts)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"   # 02:00 UTC daily

jobs:
  run:
    runs-on: ubuntu-latest
    environment: GMAIL

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # If your requirements.txt is in Stocks/, keep the first line.
      # If it's in repo root, delete the first line.
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f "Stocks/requirements.txt" ]; then pip install -r Stocks/requirements.txt; fi
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi

      - name: Debug paths (one-time, keep if needed)
        run: |
          pwd
          ls -la
          find . -maxdepth 4 -name "TotalNarrow*.py" -o -name "TotalNarrow.py"

      # ✅ Adjust the script path to YOUR repo:
      # If file is at repo root: python TotalNarrow.py
      # If file is under Stocks/: python Stocks/TotalNarrow.py
      - name: Run Turtle script
        run: |
          python TotalNarrow.py \
            --system 1 \
            --allow-shorts 1 \
            --top 5000 \
            --save entries_tomorrow.csv \
            --emit-checklist 1

      # ✅ Shows which secrets are present without leaking them
      - name: Check email secrets (SET/MISSING)
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          EMAIL_TO:  ${{ secrets.EMAIL_TO }}
        run: |
          python - <<'PY'
          import os
          for k in ["SMTP_HOST","SMTP_PORT","SMTP_USER","SMTP_PASS","EMAIL_TO"]:
              print(k, "SET" if (os.environ.get(k,"").strip()) else "MISSING")
          PY

      # ✅ Email step: safe port parsing + clear missing-secret message
      - name: Email outputs (CSV + TXT)
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          EMAIL_TO:  ${{ secrets.EMAIL_TO }}
        run: |
          python - <<'PY'
          import os, glob, smtplib
          from email.message import EmailMessage

          host = (os.environ.get("SMTP_HOST") or "").strip()
          port_raw = (os.environ.get("SMTP_PORT") or "").strip()
          user = (os.environ.get("SMTP_USER") or "").strip()
          pw   = (os.environ.get("SMTP_PASS") or "").strip()
          to   = (os.environ.get("EMAIL_TO")  or "").strip()

          missing = [k for k,v in [("SMTP_HOST",host),("SMTP_USER",user),("SMTP_PASS",pw),("EMAIL_TO",to)] if not v]
          if missing:
              raise SystemExit(
                  "Missing GitHub Secrets: " + ", ".join(missing) +
                  ". Add them in Settings → Secrets and variables → Actions."
              )

          # ✅ if SMTP_PORT is blank or not numeric, default to 587
          port = int(port_raw) if port_raw.isdigit() else 587

          csv_files = glob.glob("*.csv")
          txt_files = glob.glob("*.txt")
          files = csv_files + txt_files

          msg = EmailMessage()
          msg["Subject"] = "Turtle Scanner Output"
          msg["From"] = user
          msg["To"] = to
          msg.set_content("Attached: " + ", ".join(files) if files else "No output files found.")

          for fp in files:
              with open(fp, "rb") as f:
                  data = f.read()
              maintype, subtype = ("text","csv") if fp.endswith(".csv") else ("text","plain")
              msg.add_attachment(data, maintype=maintype, subtype=subtype, filename=os.path.basename(fp))

          with smtplib.SMTP(host, port) as s:
              s.starttls()
              s.login(user, pw)
              s.send_message(msg)

          print("Email sent.")
          PY

      # ✅ Always upload files so you can download them from Actions
      - name: Upload outputs as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: turtle-output
          path: |
            *.csv
            *.txt
