- name: NarrowStockScreener
  env:
    SMTP_HOST: ${{ secrets.SMTP_HOST }}
    SMTP_PORT: ${{ secrets.SMTP_PORT }}
    SMTP_USER: ${{ secrets.SMTP_USER }}
    SMTP_PASS: ${{ secrets.SMTP_PASS }}
    EMAIL_TO:  ${{ secrets.EMAIL_TO }}
  run: |
    python - <<'PY'
    import os, glob, smtplib
    from email.message import EmailMessage

    host = (os.environ.get("SMTP_HOST") or "").strip()
    port_raw = (os.environ.get("SMTP_PORT") or "").strip()
    user = (os.environ.get("SMTP_USER") or "").strip()
    pw   = (os.environ.get("SMTP_PASS") or "").strip()
    to   = (os.environ.get("EMAIL_TO")  or "").strip()

    missing = [k for k,v in [("SMTP_HOST",host),("SMTP_USER",user),("SMTP_PASS",pw),("EMAIL_TO",to)] if not v]
    if missing:
        raise SystemExit("Missing GitHub Secrets: " + ", ".join(missing))

    port = int(port_raw) if port_raw.isdigit() else 587

    # Read checklist text if it exists
    txt_files = sorted(glob.glob("*_checklist_*.txt"))
    if txt_files:
        with open(txt_files[-1], "r", encoding="utf-8") as f:
            body = f.read()
    else:
        body = "Turtle Scanner ran successfully, but no checklist file was found."

    msg = EmailMessage()
    msg["Subject"] = "Turtle Scanner – Tomorrow’s Entries"
    msg["From"] = f"Turtle Scanner <{user}>"
    msg["To"] = to
    msg.set_content(body)

    with smtplib.SMTP(host, port) as s:
        s.starttls()
        s.login(user, pw)
        s.send_message(msg)

    print("Email sent (text-only).")
    PY
