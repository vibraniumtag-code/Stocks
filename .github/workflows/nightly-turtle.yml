name: Nightly Turtle Scanner (Email Body)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2,14 * * *"  # 02:00 UTC daily

jobs:
  run:
    runs-on: ubuntu-latest
    environment: GMAIL   # <-- remove this line if you're NOT using Environment secrets

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f "Stocks/requirements.txt" ]; then pip install -r Stocks/requirements.txt; fi
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi

      # ✅ Adjust this path to your script location:
      - name: Run Turtle script
        run: |
          python TotalNarrow.py \
            --system 1 \
            --allow-shorts 1 \
            --top 5000 \
            --save entries_tomorrow.csv \
            --emit-checklist 1

      - name: Email checklist (text body only)
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          EMAIL_TO:  ${{ secrets.EMAIL_TO }}
        run: |
          python - <<'PY'
          import os, glob, smtplib
          from email.message import EmailMessage

          host = (os.environ.get("SMTP_HOST") or "").strip()
          port_raw = (os.environ.get("SMTP_PORT") or "").strip()
          user = (os.environ.get("SMTP_USER") or "").strip()
          pw   = (os.environ.get("SMTP_PASS") or "").strip()
          to   = (os.environ.get("EMAIL_TO")  or "").strip()

          missing = [k for k,v in [("SMTP_HOST",host),("SMTP_USER",user),("SMTP_PASS",pw),("EMAIL_TO",to)] if not v]
          if missing:
              raise SystemExit("Missing GitHub Secrets: " + ", ".join(missing))

          port = int(port_raw) if port_raw.isdigit() else 587

          txt_files = sorted(glob.glob("*_checklist_*.txt"))
          if txt_files:
              with open(txt_files[-1], "r", encoding="utf-8") as f:
                  body = f.read()
          else:
              body = "Turtle Scanner ran, but no checklist file was found."

          msg = EmailMessage()
          msg["Subject"] = "Scanner – Tomorrow’s Entries"
          msg["From"] = f"Scanner <{user}>"
          msg["To"] = to
          msg.set_content(body)

          with smtplib.SMTP(host, port) as s:
              s.starttls()
              s.login(user, pw)
              s.send_message(msg)

          print("Email sent (text-only).")
          PY
