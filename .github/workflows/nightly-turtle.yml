name: Nightly Turtle Scanner (Email Output)
env:
    SMTP_HOST: ${{ secrets.SMTP_HOST }}
    SMTP_PORT: ${{ secrets.SMTP_PORT }}
    SMTP_USER: ${{ secrets.SMTP_USER }}
    SMTP_PASS: ${{ secrets.SMTP_PASS }}
    EMAIL_TO:  ${{ secrets.EMAIL_TO }}
on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"  # daily 2:00 UTC

jobs:
  run-and-email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || pip install -r requirements.txt

      - name: Run script
        run: |
          python TotalNarrow.py \
            --system 1 --allow-shorts 1 --top 300 \
            --save entries_tomorrow.csv \
            --emit-checklist 1

      - name: Email outputs (CSV + TXT)
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          EMAIL_TO:  ${{ secrets.EMAIL_TO }}
        run: |
          python - <<'PY'
          import os, glob, smtplib
          from email.message import EmailMessage

          host = os.environ["SMTP_HOST"]
          port = int(os.environ.get("SMTP_PORT","587"))
          user = os.environ["SMTP_USER"]
          pw   = os.environ["SMTP_PASS"]
          to   = os.environ["EMAIL_TO"]

          csv_files = glob.glob("*.csv")
          txt_files = glob.glob("*.txt")

          msg = EmailMessage()
          msg["Subject"] = "Turtle Scanner Output"
          msg["From"] = user
          msg["To"] = to

          body = []
          if csv_files: body.append("Attached: " + ", ".join(csv_files))
          if txt_files: body.append("Attached: " + ", ".join(txt_files))
          if not body: body.append("No output files found to attach.")
          msg.set_content("\n".join(body))

          for fp in csv_files + txt_files:
            with open(fp, "rb") as f:
              data = f.read()
            maintype, subtype = ("text","csv") if fp.endswith(".csv") else ("text","plain")
            msg.add_attachment(data, maintype=maintype, subtype=subtype, filename=os.path.basename(fp))

          with smtplib.SMTP(host, port) as s:
            s.starttls()
            s.login(user, pw)
            s.send_message(msg)
          print("Email sent.")
          PY
